{% extends 'base.html.twig' %}

{% block title %}Hello ChatController!{% endblock %}

{% block body %}
<div class="row">
    <div class="container">
        <div class="col-md-12">
            <select id="salon" class="form-control">
                {% for chat in chat %}
                    <option class="selectSalon" value="{{chat.salon.id}}" data-user="{{chat.user.id}}">{{chat.salon.name}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<div class="row">
    <div class="container">
        <div class="col-md-12 border border-dark rounded" id="listMessage">
        </div>
    </div>
</div>
<div class="row">
    <div class="container text-center mt-3">
        <form id="stop" class="form-inline">
            <div class="col-md-10">
                <input type="text" class="form-control formInput" id="message">
            </div>
            <div class="col-md-2">
                <button class="btn formButton m-0">Envoyer</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}

	<script>
        $(function(){

            $("#salon").on('change', function(){

                let idSalon = $(this).val();
                let idUser = $('.selectSalon').data('user');
                console.log(idSalon);
                console.log(idUser);
                $.ajax({

                    type: 'post',
                    url: '{{ path("changeSalon") }}',
                    data: 'idSalon=' + idSalon + '&idUser=' + idUser,
                    datatype: 'html',
                    success: function(result){
                        $("#listMessage").empty().append(result);
                    },
                    error: function(error){
                        console.log(error);
                    }

                }) 
            })
            $("#stop").on('submit', function(e){
                e.preventDefault();
                let setSalon = $('#salon').val();
                let setUser = $('.selectSalon').data('user');

                let message = $('#message').val();
                let idSalon = setSalon;
                let idUser = setUser;

                console.log(message);
                console.log(idSalon);
                console.log(idUser);
                $.ajax({

                    type: 'post',
                    url: '{{ path("addMessage") }}',
                    data: 'message='+ message + '&idSalon=' + idSalon + '&idUser=' + idUser,
                    datatype: 'html'
                })
            })

            function refresh(){
                let idSalon = $('#salon').val();
                let idUser = $('.selectSalon').data('user');

                $.ajax({
                    type: 'post',
                    url: '{{ path("changeSalon") }}',
                    data: 'idSalon=' + idSalon + '&idUser=' + idUser, 
                    timeout: 3000, // Si il a pas de réponse au bout de XXXX milliseconde, on déclenche une erreur
                    dataType: 'html', //On veut récupérer du HTML
                    success: function(result){
                        $("#listMessage").html(result);
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            };
        
            setInterval(refresh, 3000);
        })
    </script>
{% endblock %}

